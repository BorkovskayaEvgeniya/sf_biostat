---
title: "HW4"
author: "Borkovskaya_Evgeniya"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

## Домашнее задание 3: Использование основных статистических тестов и поправок на множественные сравнения

## Задание 1 (2 балла)

Рассмотрите следующую статистическую гипотезу.

Проводят некоторое исследование пациентов с артериальной гипертензией. Предположим, что внедрение нового препарата в среднем лучше снижает их давление по сравнению со стандартной терапией.

Задайте seed для воспроизводимости результатов (функция set.seed()). Задайте размер выборки sample_size \<- 30. Задайте значение среднего артериального давления до приема нового препарата и после.

Затем:

-   Сформулируйте нулевую и альтернативную гипотезы.

-   Определите уровень значимости.

-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.

-   Определите наблюдаемое значение статистики, а также критическое значение статистики.

-   Оцените и прокомментируйте статистическую значимость.

    ***Рассмотрим два варианта задачи, так как не до конца понятно, что ожидается в решении (заявленная гипотеза о разницы эффекта нового препарата и стандартной терапии немного не согласуется с дальнейшим условием). Вначале определим, действительно ли новый препарат значимо снижает давление. А далее сравним результаты двух терапий.***

    ***Вначале проверим, действительно ли новый препарат значимо снижает давление.***

```{r, include=TRUE}
# Устанавливаем seed для воспроизводимости результатов
set.seed(40)

# Задаем размер выборки
sample_size <- 30

# Параметры для среднего артериального давления до и изменений после приема препарата
mean_before <- 140  # Среднее артериальное давление до приема препарата
std_before <- 10    # Стандартное отклонение давления до приема препарата
mean_change <- -10   # Среднее изменение давления после препарата
std_change <- 5     # Стандартное отклонение изменения давления

# Генерируем данные
pressure_before <- rnorm(sample_size, mean_before, std_before)
pressure_change <- rnorm(sample_size, mean_change, std_change)
pressure_after <- pressure_before + pressure_change
```

***Нулевая гипотеза (H0):***

***Введение нового препарата не влияет на среднее артериальное давление пациентов с артериальной гипертензией, т.е. разница в среднем артериальном давлении до и после приема препарата равна нулю.***

***Альтернативная гипотеза (H1):***

***Введение нового препарата снижает среднее артериальное давление пациентов с артериальной гипертензией, т.е. среднее артериальное давление после приема препарата ниже, чем до его приема.***

***Уровень значимости зададим 0.01, так как в клинических испытаниях лекарств, требуется более строгий уровень значимости (относительно стандартного значения 0.05), чтобы уменьшить вероятность ложноположительных результатов.***

***Выбор теста зависит от распределения данных и характера переменных. В данном случае, мы сравниваем средние двух зависимых выборок с нормальным распределением (до и после введения препарата для одних и тех же пациентов), что предполагает использование t-теста для зависимых выборок.***

```{r, include=TRUE}
# Выполняем t-тест для зависимых выборок
test_result <- t.test(pressure_before, pressure_after, paired = TRUE)
test_result
```

```{r, include=TRUE}
# Находим критическое значение для альфа = 0.01 и двустороннего теста
round(qt(0.995, 29), 2)
```

***По результатам t-теста для зависимых выборок мы получили следующие значения:***

***Наблюдаемое значение t-статистики: 8.8466***

***p-value: 9.856e-10***

***Так как p-value значительно меньше уровня значимости 0.01, мы отклоняем нулевую гипотезу. Это означает, что есть статистически значимые доказательства того, что введение нового препарата снижает артериальное давление у пациентов с артериальной гипертензией.***

***Большое значение t-статистики (больше критического) и маленькое p-value указывают на то, что разница в артериальном давлении до и после приема препарата не является случайной и может быть приписана эффекту нового препарата.***

***Далее сравним, действительно ли внедрение нового препарата в среднем лучше снижает давление пациентов по сравнению со стандартной терапией.***

```{r, include=TRUE}
# Устанавливаем seed для воспроизводимости результатов
set.seed(40)

# Параметры для группы со стандартной терапией
mean_standard <- 7  # Среднее снижение давления для стандартной терапии
std_standard <- 4   # Стандартное отклонение для стандартной терапии

# Параметры для группы с новым препаратом
mean_new_drug <- 10  # Среднее снижение давления для нового препарата
std_new_drug <- 5   # Стандартное отклонение для нового препарата

# Генерация данных для обеих групп
change_standard <- rnorm(sample_size, mean_standard, std_standard)
change_new_drug <- rnorm(sample_size, mean_new_drug, std_new_drug)
```

***Нулевая гипотеза (H0):***

***Среднее снижение артериального давления у группы, получающей новый препарат, не отличается от среднего снижения давления у группы, получающей стандартную терапию.***

***Альтернативная гипотеза (H1):***

***Среднее снижение артериального давления у группы, получающей новый препарат, больше, чем у группы, получающей стандартную терапию.***

***Уровень значимости оставим 0.01.***

***В этом случае, поскольку мы сравниваем средние двух независимых групп, наиболее подходящим будет двухвыборочный t-тест для независимых выборок (данные сгенерированные из нормального распределения).***

```{r, include=TRUE}
# Выполнение двухвыборочного t-теста для независимых выборок
t_test_result <- t.test(change_new_drug, change_standard, alternative = "greater")
t_test_result
```

```{r, include=TRUE}
# Находим критическое значение для альфа = 0.01 и одностороннего теста
round(qt(0.99, 29), 2)
```

***Наблюдаемое значение t-статистики: 4.5988***

***p-value: 1.207e-05***

***Так как p-value меньше установленного уровня значимости 0.01, а значение t-статистики больше критического значения, мы отклоняем нулевую гипотезу. Это указывает на то, что есть статистически значимые доказательства в пользу альтернативной гипотезы, а именно, что среднее снижение артериального давления в группе, получающей новый препарат, больше, чем в группе, получающей стандартную терапию.***

## Задание 2 (2 балла)

Рассмотрите следующую статистическую гипотезу.

Существует некоторая связь между курением и развитием рака легких. Пусть у курящих людей вероятность заболеть раком легких составляет 0.8, а у некурящих — 0.2

Рассмотрите два случая: для выборки sample_size1 \<- 100 и выборки sample_size2 \<- 30. Сгенерируйте данные по курению с помощью функции rep(), пусть отношение числа курящих к некурящим в каждой выборке составляет 1:1.

Затем:

-   Сформулируйте нулевую и альтернативную гипотезы.

-   Определите уровень значимости.

-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.

-   Определите наблюдаемое значение статистики, а также критическое значение статистики.

-   Оцените и прокомментируйте статистическую значимость.

***Реализуем решение для случая с размером выборки 100.***

```{r, include=TRUE}
# Устанавливаем seed для воспроизводимости результатов
set.seed(40)

# Установка параметров для выборок
sample_size1 <- 100
prop_smokers <- 0.8
prop_nonsmokers <- 0.2

# Генерация статуса курения (0 - не курит, 1 - курит) # Половина выборки курит, половина - нет
smoking_status <- c(rep(0, sample_size1 / 2), rep(1, sample_size1 / 2))

# Генерация наличия рака легких
cancer_non_smokers <- rbinom(sample_size1 / 2, 1, 0.2)
cancer_smokers <- rbinom(sample_size1 / 2, 1, 0.8)

# Объединение данных о наличии рака в один вектор
cancer_status <- c(cancer_non_smokers, cancer_smokers)

# Создание итоговой таблицы
data <- data.frame(Smoking_Status = smoking_status, Cancer_Status = cancer_status)

# Создание контингентной таблицы
contingency_table <- table(data$Smoking_Status, data$Cancer_Status)

# Переименование строк и столбцов для лучшей читаемости
dimnames(contingency_table) <- list(Smoking_Status = c("Non-Smokers", "Smokers"),
                                     Cancer_Status = c("No Cancer", "Cancer"))

contingency_table
```

***Нулевая гипотеза (H0):***

***Нет связи между курением и развитием рака легких. Любые наблюдаемые различия могут быть объяснены случайностью.***

***Альтернативная гипотеза (H1):***

***Существует связь между курением и развитием рака легких.***

***В данном случае зададим стандартный уровень значимости 0.05.***

***В задаче нужно рассмотреть связь между курением и развитием рака легких с заданными вероятностями заболеваемости для курящих и некурящих. Будем рассмотривать статус курения (курящий/некурящий) и наличие рака легких (есть рак/нет рака) как категориальные переменные. Также стоит отметить, что наблюдения рассматриваем как независимые.***

***Для размера выборки 100 подходит тест хи-квадрат (категориальные независимые данные и более 5 наблюдений в таблице сопряженности для каждого случая).***

```{r, include=TRUE}
# Выполнение хи-квадрат теста
chi_test_result <- chisq.test(contingency_table)
chi_test_result
```

```{r, include=TRUE}
#Находим критическое значение для альфа = 0.05
round(qchisq(0.95, 1), 2)
```

***Наблюдаемое значение статистики X-squared: 4.5988***

***p-value: 1.207e-05***

***Значение p-value меньше заданного уровня значимости 0.05, что указывает на очень низкую вероятность того, что наблюдаемые различия между курящими и некурящими могут быть случайными. Таким образом, мы отклоняем нулевую гипотезу и делаем вывод о наличии статистически значимой связи между курением и развитием рака легких. Наблюдаемое значение статистики значительно превышает критическое значение, подтверждая статистическую значимость результатов.***

***Далее рассмотрим выборку размера 30.***

```{r, include=TRUE}
# Устанавливаем seed для воспроизводимости результатов
set.seed(20)

sample_size2 <- 30

# Генерация статуса курения (0 - не курит, 1 - курит) # Половина выборки курит, половина - нет
smoking_status <- c(rep(0, sample_size2 / 2), rep(1, sample_size2 / 2))

# Генерация наличия рака легких
cancer_non_smokers <- rbinom(sample_size2 / 2, 1, 0.2)
cancer_smokers <- rbinom(sample_size2 / 2, 1, 0.8)

# Объединение данных о наличии рака в один вектор
cancer_status <- c(cancer_non_smokers, cancer_smokers)

# Создание итоговой таблицы
data <- data.frame(Smoking_Status = smoking_status, Cancer_Status = cancer_status)

# Создание контингентной таблицы
contingency_table <- table(data$Smoking_Status, data$Cancer_Status)

# Переименование строк и столбцов для лучшей читаемости
dimnames(contingency_table) <- list(Smoking_Status = c("Non-Smokers", "Smokers"),
                                     Cancer_Status = c("No Cancer", "Cancer"))

contingency_table
```

***В данном случае мы не можем использовать тест X-squared, так как количество наблюдений в таблице сопряженности для двух случаев менее 5. Используем его аналог - точный тест Фишера.***

```{r, include=TRUE}
# Выполнение точного теста Фишера
fisher_test_result <- fisher.test(contingency_table)
fisher_test_result
```

***Наблюдаемое значение p-value: 0.002814***

***odds ratio : 14.11256***

***Ключевым результатом в данном случае является p-value. Значение p-value меньше заданного уровня значимости 0.05, что указывает на то, что вероятность наблюдаемых различий между курящими и некурящими в отношении развития рака легких случайна крайне мала. Таким образом, отклоняем нулевую гипотезу, что означает наличие статистически значимых доказательств связи между курением и развитием рака легких в вашей выборке.***

***Также представлена оценка шансов (odds ratio). Значение показывает, что шансы на развитие рака легких у курящих в вашей выборке примерно в 14 раз выше, чем у некурящих.***

## Задание 3 (3 балла)

Рассмотрите следующую статистическую гипотезу.

Применение нового метода лечения синдрома раздраженного кишечника значимо меняет уровень болевых симптомов по сравнению с группой, прошедшей лечение диетотерапией.

Исследователь избегает любых допущений, кроме того, что выборки независимы и имеют одинаковое распределение.

Что нужно сделать:

-   Сформулируйте нулевую и альтернативную гипотезы.

-   Определите уровень значимости.

-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.

-   Определите наблюдаемое значение статистики, а также критическое значение статистики.

-   Оцените и прокомментируйте статистическую значимость.

    ***Для решения рассматривается исспользование несколькоих способов генерации данный: из нормального распределения и из равномерного дискретного.***

    ***Так как нет реальных данных, решила рассмотреть оба варианта.***

    ***Для оценки данных, сгенерированных из нормального распределения с одинаковыми размерами выборок, мы используем двухвыборочный t-тест для независимых выборок. Этот тест позволяет сравнивать средние значения двух групп и является подходящим выбором, когда данные приблизительно нормально распределены и есть предположение о равенстве дисперсий в группах.***

    ***Нулевая гипотеза (H0):***

    ***Средний уровень болевых симптомов для группы, прошедшей лечение новым методом, равен среднему уровню болевых симптомов для группы, прошедшей диетотерапию. Это предполагает, что новый метод лечения не оказывает значимого влияния на уровень болевых симптомов по сравнению с диетотерапией.***

    ***Альтернативная гипотеза (H1):***

    ***Средний уровень болевых симптомов для группы с новым методом лечения отличается от среднего уровня для группы с диетотерапией. Это указывает на потенциальное влияние нового метода лечения на уровень болевых симптомов.***

    ***Для анализа выберем стандартный уровень значимости 0.05. Это означает, что мы готовы принять до 5% вероятность ошибки первого рода (ложноположительный результат).***

    ```{r, include=TRUE}
    # Установка seed для воспроизводимости
    set.seed(40)

    # Генерация симулированных данных
    pain_levels_diet <- rnorm(30, mean = 5, sd = 2)
    pain_levels_new_treatment <- rnorm(30, mean = 4, sd = 2)

    # Объединение данных в один вектор
    combined_data <- c(pain_levels_diet, pain_levels_new_treatment)

    # Создание вектора групп
    group <- factor(c(rep("Diet", length(pain_levels_diet)), 
                      rep("NewTreatment", length(pain_levels_new_treatment))))

    # Выполнение теста Левена для определения гомогенности дисперсий (p-value > 0.05)
    car::leveneTest(combined_data, group, center = median)
    ```

    ```{r, include=TRUE}
    # Выполнение двухвыборочного t-теста для независимых выборок
    t_test_result <- t.test(pain_levels_diet, pain_levels_new_treatment)
    t_test_result
    ```

    ```{r, include=TRUE}
    # Расчет критических значений для двустороннего t-test
    qt(0.025, 58)
    qt(0.975, 58)
    ```

    ***Наблюдаемое значение p-value: 0.9343***

    ***t-статистика : -0.082745***

    ***Полученное значение t-статистики входит в пределы критических значений, что указывает на сохранение нулевой гипотезы. Кроме того, p-value значительно больше уровня значимости, что также указывает, что мы не отклоняем нулевую гипотезу. Это означает, что на основе проведенного анализа на сгенерированных в данном примере данных нет достаточных статистических доказательств различия между средними уровнями болевых симптомов двух групп, а именно новый метод лечения и диетотерапия имеют схожее воздействие на уровень болевых симптомов у пациентов.***

***Для дискретного равномерного распределения будем использовать непараметрические тест. Использование теста Манна-Уитни ограничено присутствием связанных рангов (ties), то есть одинаковых значений данных в обеих группах. Так как мы используем целые числа и ограниченный набор значений для генерации данных, появляются повторяющиеся значения. Поэтому используем тест Краскела-Уоллиса для нашей задачи. Тест Краскела-Уоллиса — это непараметрический аналог однофакторного ANOVA, который можно использовать для сравнения более чем двух групп. Для двух групп этот тест функционально аналогичен тесту Манна-Уитни и может быть более устойчивым к связанным рангам.***

```{r, include=TRUE}
# Установка seed для воспроизводимости результатов
set.seed(42)

# Генерация симулированных данных с одинаковым распределением
# Уровни болевых симптомов могут варьироваться от 0 до 10 для обеих групп
pain_levels_diet <- runif(30, min = 0, max = 10)

# Для группы с новым методом лечения данные также генерируются в диапазоне от 0 до 10,
# но затем к каждому значению добавляется некоторое число, чтобы "сдвинуть" распределение
shift <- -2  # Сдвигаем распределение на 2 единицы влево
pain_levels_new_treatment <- runif(30, min = 0, max = 10) + shift

# Обрезаем значения, выходящие за пределы диапазона [0, 10], чтобы сохранить одинаковую форму распределения
pain_levels_new_treatment[pain_levels_new_treatment < 0] <- 0
pain_levels_new_treatment[pain_levels_new_treatment > 10] <- 10
```

***Нулевая гипотеза (H0):***

***Медианные значения уровней болевых симптомов для группы, прошедшей лечение новым методом, и для группы, прошедшей диетотерапию, равны. Нет значимого различия в эффективности двух методов лечения с точки зрения уменьшения болевых симптомов.***

***Альтернативная гипотеза (H1):***

***Медианные значения уровней болевых симптомов для этих двух групп различаются. Новый метод лечения имеет иной эффект на уровень болевых симптомов по сравнению с диетотерапией.***

***Для анализа выберем стандартный уровень значимости 0.05. Это означает, что мы готовы принять до 5% вероятность ошибки первого рода (ложноположительный результат).***

```{r, include=TRUE}
# Выполнение теста Краскела-Уоллиса
test_result <- kruskal.test(list(pain_levels_diet, pain_levels_new_treatment))
test_result
```

```{r, include=TRUE}
# Расчет критического значения для распределения хи-квадрат
round(qchisq(0.95, 1),2)
```

***Наблюдаемое значение p-value: 0.001331***

***Kruskal-Wallis chi-squared : 10.298***

***Поскольку p-value меньше стандартного уровня значимости 0.05, мы отклоняем нулевую гипотезу. Это означает, что есть статистически значимые различия между группами в уровнях болевых симптомов. Кроме того, наблюдаемая статистика Краскела-Уоллиса превышает критическое значение, что подтверждает статистически значимые различия. Таким образом, результаты теста Краскела-Уоллиса указывают на то, что новый метод лечения и диетотерапия оказывают разное воздействие на уровни болевых симптомов.***

## Задание 4 (4 балла)

Рассмотрите следующую гипотезу.

Проводится исследование, в котором исследуются три противоопухолевые препарата A, B плацебо (0) на трех группах мышей. В каждой из трех групп по 10 мышей. Оценивается размер опухоли у мыши.

Сгенерируйте датасет следующим образом:

tumor \<- tibble( therapy = c(rep("0", 10), rep("A", 10), rep("B", 10)), value = c(rep(3213, 10), rep(2687, 10), rep(2423, 10)) ) %\>% mutate(therapy = factor(therapy, levels = c("0", "A", "B"))) tumorvalue\<−tumorvalue + rnorm(30, 0, 760)

Постройте на одном графике три «ящика с усами» для наглядности.

-   Проведите дисперсионный анализ, чтобы выяснить, есть ли разница между размером опухоли во всех группах.

-   Прокомментируйте получившийся результат.

-   С помощью функции TukeyHSD() проведите попарные сравнения, используя критерий Тьюки.

-   Прокомментируйте полученные результаты.

    ```{r, include=TRUE}
    # Установка seed для воспроизводимости результатов
    set.seed(42)

    #Создание датасета tumor
    tumor <- tibble(
      therapy = c(rep("0", 10), rep("A", 10), rep("B", 10)),
      value = c(rep(3213, 10), rep(2687, 10), rep(2423, 10))
    ) %>%
      mutate(therapy = factor(therapy, levels = c("0", "A", "B")))

    tumor$value <- tumor$value + rnorm(30, 0, 760)

    #Визуализация данных с помощью boxplot
    ggplot(tumor, aes(x = therapy, y = value, fill = therapy)) +
      geom_boxplot() +
      labs(title = "Размер опухоли по группам лечения", x = "Терапия", y = "Размер опухоли") +
      theme_minimal()
    ```

    ```{r, include=TRUE}
    shapiro.test(tumor$value[tumor$therapy == "0"])
    shapiro.test(tumor$value[tumor$therapy == "A"])
    shapiro.test(tumor$value[tumor$therapy == "B"])
    ```

    ```{r, include=TRUE}
    car::leveneTest(value ~ therapy, data = tumor)
    ```

***Так как данные нормально распределены и дисперсии между выборками гомогенны, используем дисперсионный анализ (ANOVA).***

```{r, include=TRUE}
#Дисперсионный анализ (ANOVA)
anova_result <- aov(value ~ therapy, data = tumor)
summary(anova_result)
```

***P-значение меньше 0.01, что указывает на наличие статистически значимых различий в средних размерах опухолей между группами терапии. Это означает, что можно отклонить нулевую гипотезу о том, что все три группы имеют одинаковые средние значения размеров опухолей.***

***Значение F показывает, что различия между группами достаточно велики по сравнению с вариативностью внутри групп, чтобы считаться статистически значимыми.***

***В целом, результаты ANOVA предполагают, что терапия влияет на размер опухолей у мышей. Для определения между какими конкретными группами существуют различия, требуются дополнительные попарные сравнения, например, с использованием критерия Тьюки.***

```{r, include=TRUE}
#Попарные сравнения с использованием критерия Тьюки
tukey_result <- TukeyHSD(anova_result)
print(tukey_result)

```

***Исходя из результатов, можно сделать вывод, что оба противоопухолевых препарата (A и B) статистически значимо уменьшают размер опухолей по сравнению с плацебо. Однако между самими препаратами A и B статистически значимых различий в эффективности обнаружено не было. Это означает, что оба препарата могут быть эффективными в снижении размера опухолей, но нет оснований утверждать, что один препарат лучше другого.***
