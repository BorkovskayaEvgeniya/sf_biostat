---
title: "Homework № 5"
author: "Borkovskaya EV"
date: "`r Sys.Date()`"
output: html_document
---

```{=html}
<style type="text/css">
body{
  font-family: Helvetica;
  font-size: 12pt;
}
/* Headers */
h1, h2{
  font-size: 16pt;
}
</style>
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = FALSE
)
library(tidyverse)
library(ggplot2)
library(car)
library(survival)
library(survminer)
library(ggsurvfit)
```

# Описание ДЗ

Для выполнения первых двух заданий загрузите датасет [Breast Cancer Wisconsin](https://lms.skillfactory.ru/asset-v1:SkillFactory+MFTIBIO+SEP2023+type@asset+block@wisconsin_breast_cancer.csv).

В колонке **diagnosis** содержится информация об опухоли (M = злокачественная, B = доброкачественная).

```{r dataset1, include = TRUE}
df_1 <- read.csv('wisconsin_breast_cancer.csv')

# Отбираем только интересующие нас столбцы, а именно средние значения

df_1 <- df_1 %>% 
  select(1:12)

head(df_1)
```

# Задание 1

Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и:

а) средней площади,

б) среднего периметра,

в) средней симметричности.

Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

```{r model1, include=TRUE}
# Создание регрессионной модели для среднего радиуса опухоли и средней площади
model_area <- lm(radius_mean ~ area_mean, data = df_1)
summary(model_area)

# Отрисовка графика
ggplot(df_1, aes(x = radius_mean, y = area_mean)) +
  geom_point() +
  labs(title='Связь среднего радиуса и средней площади опухоли',
  x='Средний радиус опухоли' ,
  y='Средняя площадь опухоли') +
  geom_smooth(method = "lm")
```

**Выводы:** 1. При увеличении средней площади опухоли на единицу зависимая переменная среднего радиуса увеличится на 9.887e-03.

2.  Коэффициент имеет статистическую значимость, так как p-value составляет \<2e-16, что значительно меньше 0.05

3.  Высокие значения коэффициента детерминации (R-квадрат) 0.9749 и скорректированный R-квадрат 0.9748 указывают на то, что модель очень хорошо объясняет вариацию зависимой переменной. Примерно 97.49% изменчивости зависимой переменной может быть объяснено с помощью переменной 'area_mean'.

4.  Остатки имеют среднее значение, близкое к нулю, и относительно небольшой разброс между 1-м и 3-м квартилями. Это может указывать на то, что модель адекватно соответствует данным. Однако, наличие остатков с минимальным значением -4.9604 и максимальным 0.7788 могут потребовать дополнительного анализа на предмет выбросов или нелинейности.

5.  Стандартная ошибка остатков (Residual standard error) составляет 0.5591, что предоставляет информацию о том, насколько точны предсказания модели.

6.  Как мы можем видеть по графику зависимость линейная.

7.  Распределение остатков не нормальное, так как большинство точек не лежит на прямой, особенно на концах. Значит наша выборка имеет ненормальное распределение

```{r model2, include=TRUE}
# Создание регрессионной модели для среднего радиуса опухоли и среднего периметра
model_perimeter <- lm(radius_mean ~ perimeter_mean, data = df_1)
summary(model_perimeter)

# Отрисовка графика
ggplot(df_1, aes(x = radius_mean, y = perimeter_mean)) +
  geom_point() +
  labs(title='Связь среднего радиуса и среднего периметра опухоли',
  x='Средний радиус опухоли' ,
  y='Средний периметр опухоли') +
  geom_smooth(method = "lm")
```

**Выводы:** 1. При увеличении среднего периметра опухоли на единицу зависимая переменная среднего радиуса увеличится на 0.1447176.

2.  Коэффициент имеет статистическую значимость, так как p-value составляет \<2e-16, что значительно меньше 0.05

3.  Высокие значения коэффициента детерминации (R-квадрат) 0.9957 и скорректированный R-квадрат 0.9957 указывают на то, что модель очень хорошо объясняет вариацию зависимой переменной. Примерно 99.57% изменчивости зависимой переменной может быть объяснено с помощью переменной 'perimeter_mean'.

4.  Остатки имеют симметричное распределение вокруг нуля, так как медиана близка к нулю. Разница между 1-м и 3-м квартилями не очень большая, что может свидетельствовать о равномерном распределении остатков. Минимальное и максимальное значения остатков не слишком далеки от среднего значения, что может говорить о том, что модель в целом хорошо соответствует данным.

5.  Стандартная ошибка остатков (Residual standard error) составляет 0.2309, что предоставляет информацию о том, насколько точны предсказания модели.

6.  Как мы можем видеть по графику зависимость линейная.

7.  Распределение остатков нормальное, так как большинство точек лежит на прямой. Значит наша выборка имеет нормальное распределение

```{r model3, include=TRUE}
# Создание регрессионной модели для среднего радиуса опухоли и средней симметричности
model_symmetry <- lm(radius_mean ~ symmetry_mean, data = df_1)
summary(model_symmetry)

# Отрисовка графика
ggplot(df_1, aes(x = radius_mean, y = symmetry_mean)) +
  geom_point() +
  labs(title='Связь среднего радиуса и средней симметрии опухоли',
  x='Средний радиус опухоли' ,
  y='Средняя симметрия опухоли') +
  geom_smooth(method = "lm")
```

**Выводы:** 1. При увеличении среднего периметра опухоли на единицу зависимая переменная среднего радиуса увеличится на 18.9918.

2.  Коэффициент имеет статистическую значимость, так как p-value составляет 0.000406, что меньше 0.05

3.  Низкие значения коэффициента детерминации (R-квадрат) 0.02183 и скорректированный R-квадрат 0.0201 указывают на то, что модель не очень хорошо объясняет вариацию зависимой переменной. Примерно 2.2% изменчивости зависимой переменной может быть объяснено с помощью переменной 'symmetry_mean'.

4.  Остатки кажутся асимметричными, так как медиана (-0.5862) смещена влево от середины диапазона между 1-м и 3-м квартилями. Максимальное значение (14.2934) и минимальное значение (-7.3711) довольно далеки от медианы, что может свидетельствовать о потенциальных выбросах в данных.

5.  Стандартная ошибка остатков (Residual standard error) составляет 0.2309, что предоставляет информацию о том, насколько точны предсказания модели.

6.  Как мы можем видеть по графику зависимость нелинейная.

7.  Распределение остатков ненормальное, так как большинство точек не лежит на прямой. Значит наша выборка имеет ненормальное распределение

# Задание 2

Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).

Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

```{r mutate_df, include=TRUE}
# Заменим значения в колонке diagnosis на бинарные значения 1 и 0
df_1 <- df_1  %>% 
  mutate(diagnosis = ifelse(diagnosis == 'M', 1, 0))

# Построим модель логистической регресии
model_diagnosis <- glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = df_1, family = 'binomial')
summary(model_diagnosis)

# Отрисовка графиков
# График вероятности злокачественной опухоли от среднего радиуса
ggplot(df_1, aes(x = radius_mean, y = diagnosis)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial")) +
  labs(title = "Вероятность злокачественной опухоли от среднего радиуса",
       x = "Средний радиус",
       y = "Вероятность злокачественно опухоли")

# График вероятности злокачественной опухоли от средней площади
ggplot(df_1, aes(x = area_mean, y = diagnosis)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial")) +
  labs(title = "Вероятность злокачественной опухоли от средней площади",
       x = "Средняя площадь",
       y = "Вероятность злокачественно опухоли")

# График вероятности злокачественной опухоли от средней текстуры
ggplot(df_1, aes(x = texture_mean, y = diagnosis)) +
  geom_point() +
  stat_smooth(method = "glm", 
              method.args = list(family = "binomial")) +
  labs(title = "Вероятность злокачественной опухоли от средней текстуры",
       x = "Средняя текстура",
       y = "Вероятность злокачественно опухоли")
```

**Выводы:**

1.  Коэффициент (Intercept) статистически не значим, как указано его p-value равно 0.168, что выше общепринятого порога в 0.05.

2.  'radius_mean' имеет высокое p-value 0.687, что предполагает, что его связь с зависимой переменной статистически не значима.

3.  'area_mean' имеет высокое p-value 0.137, что предполагает, что его связь с зависимой переменной статистически не значима.

4.  'texture_mean' очень значим, так как p-value 1.78e-08.

# Задание 3

Для выполнения этого задания вам понадобится датасет **lung**, который встроен в пакет **survival**. Установите этот пакет и загрузите датасет.

Датасет содержит следующий набор переменных:

-   inst: код учреждения;

-   time: время выживаемости в днях;

-   status: 1 = цензурирование, 2 = смерть;

-   age: возраст в годах;

-   sex: мужской = 1, женский = 2;

-   ph.ecog: шкала опросника ECOG (оценку проводит врач).

    -   0 = отсутствие симптомов,

    -   1 = симптомы есть, но пациент наблюдается амбулаторно,

    -   2 = меньше половины дня пациент вынужден проводить в постели,

    -   3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели,

    -   4 = прикован к постели;

-   ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;

-   pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;

-   meal.cal: калории потребляемой пищи;

-   wt.loss: потеря веса за последние полгода.

Создайте переменную **event**, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

Изучите работу функций **Surv()**, **survfit()** и **ggsurvplot()**:

-   Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.

-   Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.

-   С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?

```{r task_3, include=TRUE}
# Инициализация датасета
data <- survival::lung

# Создание переменной event, обозначающее летальный исход
data <- data %>%
  mutate(event = ifelse(status == 2, 1, 0))

# Создание объекта выживаемости
sfit <- survfit(Surv(time, event) ~ sex, data = data)

# Визуализация кривых выживаемости
ggsurvplot(
  sfit, 
  data = data, 
  risk.table = TRUE, 
  pval = TRUE,
  legend.title = "Пол",
  legend.labs = c("Мужской", "Женский") 
) 
# Построение графика кумулятивной функции рисков
ggsurvplot(
  sfit, 
  data = data,
  fun = "cumhaz", 
  risk.table = TRUE,
  pval = TRUE,
  legend.title = "Пол",
  legend.labs = c("Мужской", "Женский")
)

# Строим регрессию Кокса
cox_model <- coxph(Surv(time, event) ~ sex, data = data)
summary(cox_model)
```

**Выводы:**

1.  p-value из лог-рангового теста 0.0013, что значит между группами в выживаемости есть статистически значимые различия.

2.  На графике кривых выживаемости видим, что кривая женского пола выше, чем кривая мужского пола. А значит женщины имеют более высокую вероятность выживвания в течение определенного периода времени по сравнению с мужчинами.

3.  По графику куммулятивной функции риска мы видим аналогичную ситуацию, что мужчины показыают более высокую вероятность наступления летального исхода с течением времени.

4.  По результатам регрессии Кокса мы видим, что р-value= 0.00149 указывает на то, что пол оказывает статистически значимое влияние на выживаемость (p \< 0.05), что также подтверждается ДИ, который не включает 1.
